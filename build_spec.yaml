version: 0.1
component: build
timeoutInSeconds: 600
runAs: root
shell: bash
failImmediatelyOnError: true

env:
  variables:
    "JAVA_HOME": "/usr/lib/jvm/java-11-openjdk"

  exportedVariables:
    - REGISTRY
    - BUILD_RUN

steps:
  - type: Command
    name: "Setup environment variables"
    command: |
      export REGISTRY=`echo mx-queretaro-1.ocir.io/axlwhym3ptje/reacttodo/ps8j4`
      echo "REGISTRY: " ${REGISTRY}
  
  - type: Command
    name: "Define unique image tag"
    command: |
      export BUILD_RUN=`echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7`
      echo "BUILD_RUN: " $BUILD_RUN

  - type: Command
    name: "Set the Java path"
    command: |
      export JAVA_HOME=${OCI_PRIMARY_SOURCE_DIR}/graalvm-ce-java11-21.0.0
      export PATH=$JAVA_HOME/bin:$PATH

  - type: Command
    name: "Build app"
    command: |
      pwd
      ls
      cd MtdrSpring/backend
      pwd
      ls
      mvn clean package spring-boot:repackage -Pnative
      if [ $? -ne 0 ]; then
        echo "Maven build failed"
        exit 1
      fi

  - type: Command
    name: "Build backend image"
    command: |
      cd MtdrSpring/backend
      docker build --platform=linux/aarch64 -f Dockerfile -t backend-image .
      echo "Backend image built"

outputArtifacts:
  - name: todolistapp-springboot
    type: DOCKER_IMAGE
    location: backend-image
